<!DOCTYPE html>

<html>
<head>
  <title>database.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>database.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/* global console, require, __dirname, process, module */</span>
<span class="hljs-comment">/* jshint node: true */</span>
<span class="hljs-comment">/* jshint esnext: true */</span>
<span class="hljs-pi">
"use strict"</span>;

<span class="hljs-keyword">var</span> Q = <span class="hljs-built_in">require</span>(<span class="hljs-string">"q"</span>);
<span class="hljs-keyword">var</span> mongo = <span class="hljs-built_in">require</span>(<span class="hljs-string">"mongodb"</span>);
<span class="hljs-keyword">var</span> ObjectID = mongo.ObjectID;
<span class="hljs-keyword">var</span> MongoClient = mongo.MongoClient;
<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">"lodash"</span>);
<span class="hljs-keyword">var</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../config/config"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Building the ‘nnngh’ mongodb connection string from the values :)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> connectionString = <span class="hljs-string">"mongodb://"</span> + config.databaseUser + <span class="hljs-string">":"</span> + 
    config.databasePassword + <span class="hljs-string">"@"</span> + 
    config.databaseUrl + <span class="hljs-string">":"</span> + 
    config.databasePort + <span class="hljs-string">"/"</span> + 
    config.database;
<span class="hljs-keyword">var</span> database;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Collections 
NOTE if the collections related code gets too out of hand, move it to its own module</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> dashboard;
<span class="hljs-keyword">var</span> components;

<span class="hljs-comment">/**
 * Initializes the Mongo database connection. Opens the connection to the database and to the associated collections.
 * @returns {Q.Promise} Resolves on success.
 */</span>
<span class="hljs-keyword">var</span> init = () =&gt; {
    <span class="hljs-keyword">var</span> deferred = Q.defer();

    Q.ninvoke(MongoClient, <span class="hljs-string">"connect"</span>, connectionString)
        .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(connectedDatabase)</span> </span>{
            database = connectedDatabase;
            dashboard = getCollection(<span class="hljs-string">"dashboard"</span>)();
            components = getCollection(<span class="hljs-string">"components"</span>)();
            deferred.resolve(<span class="hljs-literal">true</span>);
        })
        .catch(deferred.reject)
        .done();

    <span class="hljs-keyword">return</span> deferred.promise;
};

<span class="hljs-comment">/**
 * Gets a specific connection to a Collection in the MongoDb
 * @returns {Object} Returns mongodb collection.
 */</span>
<span class="hljs-keyword">var</span> getCollection = collection =&gt; {
    <span class="hljs-keyword">if</span> (!database) {
        <span class="hljs-keyword">throw</span> <span class="hljs-string">"No connection to database."</span>;
    } 

    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Returning requested collection."</span>, collection);
        <span class="hljs-keyword">return</span> database.collection(collection);
    };
};

<span class="hljs-comment">/** 
 * Performs a specific find-query into a given Collection in the Mongo database.
 * @collection {Object} collection MongoDb collection
 * @query {Object} Mongoclient query.
 * @returns {Q.Promise} Resolves on success.
 */</span>
<span class="hljs-keyword">var</span> find = (collection, query) =&gt; {
   <span class="hljs-keyword">var</span> deferred = Q.defer();
        
    <span class="hljs-keyword">if</span> (collection.find === <span class="hljs-literal">undefined</span>) {
        deferred.reject(<span class="hljs-string">"No find function in collection."</span>);
        <span class="hljs-keyword">return</span>;
    }
    
    collection
        .find(query)
        .toArray(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(error, documents)</span> </span>{
            <span class="hljs-keyword">if</span> (error) {
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Error getting documents for collection."</span>, error);
                deferred.reject(documents);
                <span class="hljs-keyword">return</span>;
            }

            deferred.resolve(documents);
        });

    <span class="hljs-keyword">return</span> deferred.promise;  
};

<span class="hljs-comment">/** 
 * Flattens the row structure and concantenates everything into one row for easier consumption and database querying.
 * @param {Array&lt;Array&lt;string&gt;&gt;} rows - Rows to flatten.
 * @returns {Array&lt;string&gt;} Array of strings with the component_ids inside
 */</span>
<span class="hljs-keyword">var</span> collectComponentsFromRows = rows =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>the columns are built of components (columns, single column = single component)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    
    <span class="hljs-keyword">var</span> component_ids = _.flatten(rows.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(rowColumns)</span> </span>{
        <span class="hljs-keyword">return</span> rowColumns.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(component_id)</span> </span>{  
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ObjectID(component_id);
        });
    }));
    
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Collected component_ids for Dashboard."</span>, component_ids);
    <span class="hljs-keyword">return</span> component_ids;
};

<span class="hljs-built_in">module</span>.exports = {
    init: init,
    getCollection: getCollection,

    <span class="hljs-comment">/** 
     * Finds Components for a specific Dashboard based on its component_ids and row order.
     * @param {Object} rows_component_ids double dimension array containing the order and document_ids of Components.
     * @param {Function} transformer (Optional) Transformer function that is applied to the data before it's resolved.
     * @returns {Q.Promise} Resolves on success.
     */</span>
    findComponentsForDashboard: (rows_component_ids, transformer) =&gt; {
        <span class="hljs-keyword">if</span> (transformer !== <span class="hljs-literal">undefined</span>) {
            <span class="hljs-keyword">var</span> deferred = Q.defer();</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>transformer enabled where the results are projected/transformed into something else</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            find(components, { _id: { $<span class="hljs-keyword">in</span>: collectComponentsFromRows(rows_component_ids) } })
                .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(results)</span> </span>{
                    deferred.resolve(transformer(results));
                }) 
                .catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(error)</span> </span>{
                    <span class="hljs-built_in">console</span>.error(error);
                    deferred.reject(error);
                })
                .done();
           
            <span class="hljs-keyword">return</span> deferred.promise;
        } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>raw resulting query</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">return</span> find(components, { _id: { $<span class="hljs-keyword">in</span>: collectComponentsFromRows(rows_component_ids) } });
        }
    },
    
    <span class="hljs-comment">/** 
     * Gets all Dashboards for specific Email address.
     * @param {string} email email to look for
     * @returns {Q.Promise} Resolves on success.
     */</span>
    findDashboardsForEmail: email =&gt; {
        <span class="hljs-keyword">return</span> find(dashboard, { for_emails: { $<span class="hljs-keyword">in</span>: [ email ] }});
    }
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
