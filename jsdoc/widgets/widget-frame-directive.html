<!DOCTYPE html>

<html>
<head>
  <title>widget-frame-directive.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>widget-frame-directive.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/* global gapi, console, require, angular, document, window, $ */</span>
<span class="hljs-comment">/* jslint node: true */</span>
<span class="hljs-comment">/* jshint esnext: true */</span>
<span class="hljs-pi">
"use strict"</span>;

<span class="hljs-keyword">var</span> name = <span class="hljs-string">"dash.widgets"</span>;
<span class="hljs-keyword">var</span> dependencyMap = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../dependency-map"</span>).add(name);
<span class="hljs-keyword">var</span> constants = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../../server/utilities/constants"</span>);

<span class="hljs-comment">/** 
 * Angular directive for Iframe based widgets to show external content on the Dashboard.
 * @param  {ng-service} $sce
 */</span>
<span class="hljs-keyword">var</span> elementDirective = ($sce) =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>6? don’t ask me why.. I’ll look into it later :D I need to find the element that produces this so I can dynamically
drop it out. For now this works and we need to move forward with the proto idea</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> missingHeight = <span class="hljs-number">12</span>;
    
    <span class="hljs-comment">/**
     * Linker function for the direcvite.
     * @param  {ng-scope} scope     
     * @param  {HtmlElement} element    
     * @param  {Object} attributes 
     */</span>
    <span class="hljs-keyword">var</span> elementDirectiveLink = (scope, element, attributes) =&gt; {
        <span class="hljs-keyword">if</span> (!(scope.isActive = scope.component.type === <span class="hljs-string">"IFRAME"</span>)) {
            <span class="hljs-keyword">return</span>;
        }

        scope.dynamicResize = () =&gt; {
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Resizing the iframe to fill container.."</span>, element);
            <span class="hljs-built_in">window</span>.foobar = element;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>IDEA behind the calculation: dynamically stretch the iframe to match containing div.
   The widget is made of three elements, top title element, widget container (the iframe in this case)
   and a span element for caption if the user so wishes. I need to supstract the size of the title + caption
   from the whole size of the widget (the container with the three elements in) to get the size for the
   widget div (iframe) and then apply that..</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            
            <span class="hljs-keyword">var</span> elements  = element.children()[<span class="hljs-number">0</span>];
            <span class="hljs-keyword">var</span> divHeight = $(elements).outerHeight(<span class="hljs-literal">true</span>)  - 
                (
                    $(elements.children[<span class="hljs-number">0</span>].children).outerHeight(<span class="hljs-literal">true</span>) +
                    $(elements.children[<span class="hljs-number">2</span>]).outerHeight(<span class="hljs-literal">true</span>) + missingHeight
                );
            
            <span class="hljs-keyword">var</span> outer = $(elements.children[<span class="hljs-number">1</span>].children).outerHeight(<span class="hljs-literal">true</span>);
            <span class="hljs-keyword">var</span> inner =  $(elements.children[<span class="hljs-number">1</span>].children).height();
            <span class="hljs-keyword">var</span> difference = outer - inner;
            <span class="hljs-keyword">var</span> iframeHeight = divHeight - difference;
            
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Calculated max div height is: "</span> + divHeight);
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"IFrame outer - inner = difference. "</span>, outer, <span class="hljs-string">" - "</span>, inner, <span class="hljs-string">" = "</span>, difference);
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"divHeight - difference = Iframe size. "</span>, divHeight, <span class="hljs-string">" - "</span>, difference, <span class="hljs-string">" = "</span>, iframeHeight);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Setting the iframe containing div height 
$(elements.children[1]).height(divHeight);
Now setting the iframe height to grow into the div… this is absolutely idiotic.
We calculate the difference between the outerHeight and the innerHeight (borders, margings, etc)
TODO look into more reasonable CSS solution instead of mad javascript trickery, this is idiotic.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            $(elements.children[<span class="hljs-number">1</span>].children).height(iframeHeight);
        };

        scope.component.source = $sce.trustAsResourceUrl(scope.component.source);
    };

    <span class="hljs-keyword">return</span> {
        restrict: <span class="hljs-string">"E"</span>,
        scope: {
            component: <span class="hljs-string">"="</span>
        },
        templateUrl: <span class="hljs-string">"/public/html/widgets/widget-frame-template.html"</span>,
        link: elementDirectiveLink
    };
};
elementDirective.$inject = [ <span class="hljs-string">"$sce"</span> ];
elementDirective.directiveName = <span class="hljs-string">"widgetFrame"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>There is no direct way of binding angular to elements onload event (as javascript elements onload callback looks into
window.callback (global function scope)) and angular is extremely finicky with that and it does not work with the 
common way of thinking with angular. To avoid the issue we create simple angular directive that just takes care 
of the onload ballback of the iframe element and this way we get nicely wrapped onload functionality in angular :)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-comment">/**
 * Creates a angular scope bound callback to allow easier angular style callbacks into specific elements onload callback
 * through the custom 'element-onload' attribute.
 * 
 * Solves case:
 *     &lt;iframe src="www.google.com" onload="callbackGlobalFunction()"&gt;&lt;/iframe&gt;
 *     
 * Example usage:
 *     &lt;iframe src="www.google.com" element-onload="angularScopeCallback()"&gt;&lt;/iframe&gt;
 */</span>
<span class="hljs-keyword">var</span> elementOnloadDirective = () =&gt; {
    <span class="hljs-keyword">return</span> {
        restrict: <span class="hljs-string">"A"</span>,
        scope: {
            callback: <span class="hljs-string">"&amp;elementOnload"</span>
        },
        link: (scope, element, attrs) =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>hooking up the onload event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            element.on(<span class="hljs-string">"load"</span>, () =&gt; scope.callback());
        }
    };
};
elementOnloadDirective.$inject = [ ];
elementOnloadDirective.directiveName = <span class="hljs-string">"elementOnload"</span>;

angular
    .module(name)
    .directive(elementOnloadDirective.directiveName, elementOnloadDirective)
    .directive(elementDirective.directiveName, elementDirective);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
